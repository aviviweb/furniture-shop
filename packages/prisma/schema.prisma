generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id               String            @id @default(cuid())
  tenantId         String            @unique
  name             String
  vatNumber        String?
  currency         String            @default("ILS")
  demoMode         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  brand            BrandSettings?
  users            User[]
  customers        Customer[]
  products         Product[]
  orders           Order[]
  invoiceSequences InvoiceSequence[]
  invoices         Invoice[]
  expenses         Expense[]
  deliveries       Delivery[]
  routePlans       RoutePlan[]
  notifications    Notification[]
  auditLogs        AuditLog[]
  inventories      Inventory[]
}

model BrandSettings {
  id             String  @id @default(cuid())
  companyId      String  @unique
  primaryColor   String  @default("#0ea5e9")
  secondaryColor String  @default("#10b981")
  logoUrl        String?
  domain         String?
  Company        Company @relation(fields: [companyId], references: [id])
}

model User {
  id        String   @id @default(cuid())
  companyId String
  email     String   @unique
  password  String
  role      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Company   Company  @relation(fields: [companyId], references: [id])
}

model Customer {
  id        String   @id @default(cuid())
  companyId String
  name      String
  email     String?
  phone     String?
  address   String?
  vatNumber String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Company   Company  @relation(fields: [companyId], references: [id])
  orders    Order[]
}

model Product {
  id          String           @id @default(cuid())
  companyId   String
  name        String
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  variants    ProductVariant[]
  Company     Company          @relation(fields: [companyId], references: [id])
}

model ProductVariant {
  id         String      @id @default(cuid())
  productId  String
  sku        String
  price      Decimal     @db.Decimal(10, 2)
  stock      Int         @default(0)
  Product    Product     @relation(fields: [productId], references: [id])
  Inventory  Inventory?
  orderItems OrderItem[]

  @@unique([sku])
  @@index([productId])
}

model Order {
  id         String      @id @default(cuid())
  companyId  String
  customerId String?
  status     String      @default("pending")
  total      Decimal     @db.Decimal(10, 2)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  items      OrderItem[]
  Company    Company     @relation(fields: [companyId], references: [id])
  Customer   Customer?   @relation(fields: [customerId], references: [id])
  invoices   Invoice[]
  deliveries Delivery[]

  @@index([companyId, customerId])
}

model OrderItem {
  id        String         @id @default(cuid())
  orderId   String
  variantId String
  qty       Int
  price     Decimal        @db.Decimal(10, 2)
  Order     Order          @relation(fields: [orderId], references: [id])
  Variant   ProductVariant @relation(fields: [variantId], references: [id])
}

enum InvoiceType {
  TAX
  TAX_RECEIPT
  PROFORMA
  CREDIT
}

model InvoiceSequence {
  id        String      @id @default(cuid())
  companyId String
  type      InvoiceType
  current   Int         @default(0)
  Company   Company     @relation(fields: [companyId], references: [id])

  @@unique([companyId, type])
}

model Invoice {
  id               String      @id @default(cuid())
  companyId        String
  orderId          String?
  type             InvoiceType
  invoiceNumber    Int
  allocationNumber String?
  vatRate          Decimal     @db.Decimal(4, 2)
  buyerVatNumber   String?
  currency         String      @default("ILS")
  exchangeRate     Decimal?    @db.Decimal(10, 4)
  totalBeforeVat   Decimal     @db.Decimal(12, 2)
  totalVat         Decimal     @db.Decimal(12, 2)
  totalAfterVat    Decimal     @db.Decimal(12, 2)
  issuedAt         DateTime    @default(now())
  pdfUrl           String?
  rawJsonUrl       String?
  createdBy        String

  Company Company              @relation(fields: [companyId], references: [id])
  Order   Order?               @relation(fields: [orderId], references: [id])
  parsed  InvoiceParsedFields?

  @@unique([companyId, type, invoiceNumber])
  @@index([companyId, issuedAt])
}

model InvoiceParsedFields {
  id           String    @id @default(cuid())
  invoiceId    String    @unique
  rawText      String
  merchantName String?
  vatNumber    String?
  total        Decimal?  @db.Decimal(12, 2)
  Invoice      Invoice   @relation(fields: [invoiceId], references: [id])
  expenses     Expense[]
}

model Expense {
  id         String               @id @default(cuid())
  companyId  String
  fileUrl    String
  category   String?
  amount     Decimal              @db.Decimal(12, 2)
  vatAmount  Decimal?             @db.Decimal(12, 2)
  occurredAt DateTime             @default(now())
  parsedId   String?
  Company    Company              @relation(fields: [companyId], references: [id])
  Parsed     InvoiceParsedFields? @relation(fields: [parsedId], references: [id])

  @@index([companyId])
}

model Delivery {
  id            String   @id @default(cuid())
  companyId     String
  orderId       String
  scheduledAt   DateTime
  status        String   @default("scheduled")
  driverName    String?
  installerName String?
  Company       Company  @relation(fields: [companyId], references: [id])
  Order         Order    @relation(fields: [orderId], references: [id])

  @@index([companyId, scheduledAt])
}

model RoutePlan {
  id        String   @id @default(cuid())
  companyId String
  date      DateTime
  json      Json
  Company   Company  @relation(fields: [companyId], references: [id])

  @@index([companyId, date])
}

model Notification {
  id        String   @id @default(cuid())
  companyId String
  channel   String
  target    String
  payload   Json
  status    String   @default("queued")
  createdAt DateTime @default(now())
  Company   Company  @relation(fields: [companyId], references: [id])

  @@index([companyId, status])
}

model AuditLog {
  id        String   @id @default(cuid())
  companyId String
  actorId   String
  action    String
  entity    String
  entityId  String
  meta      Json?
  createdAt DateTime @default(now())
  Company   Company  @relation(fields: [companyId], references: [id])

  @@index([companyId, createdAt])
}

model Inventory {
  id           String         @id @default(cuid())
  companyId    String
  variantId    String         @unique
  quantity     Int            @default(0)
  minThreshold Int            @default(0)
  location     String?
  updatedAt    DateTime       @updatedAt
  Company      Company        @relation(fields: [companyId], references: [id])
  Variant      ProductVariant @relation(fields: [variantId], references: [id])

  @@index([companyId])
}
